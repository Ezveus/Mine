#!/usr/bin/env ruby

load "server/Client.rb"

puts "Launching server"

def exitServer exitType
  printf "\r"
  Client.clients.each do |client|
    client.exit exitType
  end
  EM.stop_event_loop if exitType == :signalCatch
  puts "Terminating server"
  exit 0
end

port = 8080

port = ARGV[0].to_i if ARGV[0]

Signal.trap "INT" do
  exitServer :signalCatch
end

Signal.trap "TERM" do
  exitServer :signalCatch
end

begin
  EM.run do
    EM.start_server '0.0.0.0', port, Client
  end
rescue Interrupt
  puts "\rOn operating systems where Signal.trap doesn't work,"
  puts "catch Interrupt works."
  exitServer :exceptionCatch
end
